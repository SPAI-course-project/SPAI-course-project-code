/*
  ==============================================================================

    AudioFX.h
    Created: 9 Dec 2020 11:59:09am
    Author:  Jomi Verwimp

  ==============================================================================
*/

#pragma once

#include <JuceHeader.h>
#include <complex>

class FXCore {
public:
	
	FXCore();
	~FXCore();

    void performFX(const float* x, int size_x, float* y, int channel);

private:

	// FFT settings
	static constexpr auto fftOrder = 12;
	static constexpr auto fftSize = 1 << fftOrder;

	static constexpr int size_coef = 2205;
	static constexpr int M = size_coef;
	static constexpr int N = 2 << (12 - 1); // 1024 samples , 12 is result of nextpow
	static constexpr int L = N - M;

	juce::dsp::FFT fft_j;

	std::array<std::complex<float>, fftSize> fftin;
	std::array<std::complex<float>, fftSize> fftout;
	std::array<std::complex<float>, fftSize> fftout2;

	float buffer_in[5000][2];
	const int buffer_in_size = 5000;
	int buffer_in_index[2] = { 0, 0 };
	int buffer_in_samples_available[2] = { 0, 0 };
	float buffer_out[5000][2];
	const int buffer_out_size = 5000;
	int buffer_out_index[2] = { 0, 0 };
	int buffer_out_samples_available[2] = { 3000, 3000 };
	float coef[2205];
	static float buffer_left[5000];
	static float buffer_right[5000];
	static float out_buffer_left[5000];
	static float out_buffer_right[5000];

	const int coef_i[2205] = { 0,     0,     0,     0,     0,     0,    16,    25,    24,
	  23,    23,    22,    21,    21,    21,    22,    27,    16,
	  24,  -334, -8939, 15259,  1916, -8483, -5477,  5512,  3041,
	-135,   622, -4141, -1929,  4228,  3125, -3190, -2295,  1429,
	  36,  2060,   722, -3099, -1372,  2737,   693,   350, -2360,
	 623,   477,   638,   281,  -904, -1143,   623,  1395,  -141,
	-534,  -925,   821,  -470,  1381,  -641,  -637,   251,   777,
	-912,   307,   169,  -145,    13,   140,     0,  -398,   592,
	-290,   147,   -19,   142,  -240,    71,   129,   -98,   285,
	 -71,   138,  -346,   256,  -313,   277,     6,    92,  -140,
	 113,     8,   -48,   154,  -187,   213,   -49,   -95,   -44,
	  58,   130,   124,  -155,  -117,   113,    84,   203,  -158,
	  18,   -75,    49,   156,   -30,    71,  -155,  -113,   125,
	 156,    18,   -68,  -193,   144,    78,    85,  -166,   -30,
	  35,   194,   -65,   -11,   -18,   144,   -48,    49,   -85,
	  12,     0,    60,    89,   -90,    47,  -100,    44,    14,
	 -62,   110,    50,    -2,    23,   -15,   -31,    68,    14,
	  16,   -33,   142,  -132,     2,    86,    32,   -65,   110,
	  20,  -141,   116,   -12,    34,   -26,   100,   -92,    62,
	  -8,    96,   -33,    81,   -50,    -4,    88,    -9,    37,
	 -51,    50,    20,    90,   -48,    44,   -16,    52,   -16,
	  75,   -17,   -26,    83,    14,     0,    -7,    73,   -42,
	  77,   -15,    -2,   -34,    75,    12,    24,    57,    28,
	 -39,    28,    46,    -2,    51,   -29,    12,    34,    73,
	 -40,    20,    39,    38,    14,    22,   -33,    -5,    68,
	  12,    10,     8,    39,    -2,    44,   -15,    11,    56,
	  32,   -26,    -3,    41,    23,    36,    16,     3,    32,
	  47,   -20,     0,    27,    21,    33,    23,     1,     4,
	  44,    16,   -10,    34,    17,    19,     3,    14,   -10,
	  58,    38,    10,    -2,    38,     8,     4,    22,     9,
	  45,    39,    22,   -29,    60,    34,    43,    15,    27,
	 -11,    40,    27,    -1,    28,    46,    49,     6,    41,
	 -17,    56,    22,    34,    -7,    59,    21,    19,    19,
	  31,    44,    42,    37,   -28,    43,    13,    49,    -4,
	  60,     4,    59,    21,    19,    12,    56,    38,     4,
	  38,     8,    49,    18,    59,    -5,    81,    28,    35,
	  -4,    45,    26,    38,    43,    16,    49,    30,    50,
	  -4,    65,    17,    66,    15,    24,    -9,    54,    44,
	  27,    46,    26,    41,     3,    43,    -4,    73,    25,
	  32,    -7,    48,    33,    44,    34,    19,    41,    30,
	  30,    -7,    55,    29,    55,    19,    42,    23,    56,
	  24,    17,    33,    45,    40,    22,    34,    16,    57,
	  45,    31,    12,    49,    28,    27,    25,    18,    42,
	  58,    46,     5,    27,    37,    53,    35,    27,    18,
	  44,    39,    17,    30,    47,    53,    32,    28,    12,
	  36,    39,    34,    23,    35,    37,    29,    38,    20,
	  34,    43,    38,     2,    27,    33,    31,    33,    32,
	  40,    46,    38,     2,    32,    36,    44,    13,    33,
	  14,    47,    57,    13,    -5,    18,    53,    29,    32,
	 -20,    19,    26,    54,    11,    47,    30,    17,    -4,
	  13,    61,    30,    27,   -17,    48,     7,    67,     2,
	  48,    13,    33,     7,     0,    25,    36,    40,    -8,
	  49,     8,    37,    13,    39,    -4,    48,    26,     6,
	  17,    41,    17,    19,    42,    13,    39,    27,    20,
	 -20,    43,    44,    35,     5,    -2,    13,    74,    46,
	  -9,   -10,    35,    67,     6,    35,    -3,    44,    22,
	  56,    29,    21,    14,    38,    26,    22,    40,    26,
	  35,    13,    47,    16,    34,    26,    45,     7,    53,
	  -5,    -3,    25,    96,    38,    18,    -6,   -10,    54,
	  52,    60,   -30,    27,    21,    44,    33,    33,    21,
	  12,    30,    16,    27,    17,    36,     7,    44,    32,
	  33,    23,    19,    11,    27,    59,    12,    17,     8,
	  40,    44,    25,    18,    22,    35,    29,    13,    13,
	  25,    26,    30,    13,    21,    25,    33,    25,    10,
	  23,    28,    26,    16,    25,     5,    38,    40,    23,
	  16,    27,    31,     6,     9,    22,    35,    14,    23,
	   5,    30,    22,    31,    19,    14,    14,    22,    19,
	  31,    26,    28,    38,    18,    24,    25,    45,    15,
	  22,    20,    32,    29,    33,    19,    26,    44,    16,
	  34,    32,    44,    -2,    26,    17,    46,    35,    28,
	   6,    16,    41,    45,    37,    18,    26,    19,    43,
	  26,    36,    21,    40,    28,    25,    18,    25,    35,
	  33,    32,    18,    33,    28,    41,    18,    30,    23,
	  44,    31,    22,    14,    22,    47,    39,    40,    22,
	  25,    19,    41,    29,    25,     6,    18,    33,    34,
	  19,    15,    30,    15,    38,    23,    17,    -2,    38,
	  29,    34,    13,    28,    26,    29,    18,     9,    25,
	  30,    28,    11,    21,    20,    31,    24,    34,    26,
	  16,    14,    21,    25,    22,    34,    27,    23,    16,
	  25,    23,    32,    28,    23,    19,    26,    25,    14,
	  30,    39,    30,    12,    18,    23,    22,    24,    20,
	  14,    20,    31,    26,    24,    11,    23,    24,    26,
	  20,    20,    11,    17,    32,    28,    32,    27,    15,
	   2,    30,    28,    21,    19,    24,     7,    22,    25,
	  24,    21,    19,    20,     8,    26,    10,    18,    15,
	  19,    11,    21,    23,    10,    10,     9,    29,    14,
	  18,     5,    13,    12,    29,    13,    14,    14,    18,
	  13,     5,    14,     5,    21,    17,    20,     1,    16,
	  13,    15,     4,    11,     8,    12,    18,    11,     8,
	  -3,    23,    20,    16,    -2,     1,     0,    19,    18,
	  18,     5,     7,    13,    13,    22,     9,    16,     7,
	  14,     9,    11,     2,    17,    22,    25,    14,    11,
	  -4,     2,    32,    19,     9,     1,    16,    10,    28,
	  23,    17,    13,    23,    16,    11,    22,    19,    23,
	  23,    29,    12,    14,    16,    23,    18,    18,    17,
	  18,    21,    22,    24,    19,    28,    12,    19,    16,
	  26,    14,    14,    22,    19,    22,    21,    24,    14,
	  19,    19,    24,    16,    19,    15,    14,    25,    22,
	  16,    20,    22,    12,    18,    16,    15,    14,    26,
	  11,    12,    18,    14,    16,    15,    18,     7,    10,
	  10,    12,     8,    17,    20,    16,     7,     7,     8,
	  14,    14,     7,     9,     9,    17,    11,    13,    13,
	  20,     6,     5,    11,    11,    11,     6,     9,    14,
	  24,    13,    10,    12,    24,    17,    21,    15,     9,
	  18,    33,    21,    11,    22,    20,    24,    15,    23,
	  13,    19,    23,    25,    15,    20,    24,    17,    20,
	  23,    32,    10,    22,    33,    26,     6,    28,    31,
	  32,    21,    17,    18,    25,    32,    14,    21,    28,
	  31,    25,    28,    19,    25,    27,    35,    22,    18,
	  27,    29,    33,    27,    36,    30,    28,    25,    31,
	  32,    32,    31,    25,    28,    30,    33,    31,    31,
	  24,    25,    25,    25,    25,    27,    32,    22,    29,
	  28,    31,    28,    30,    15,    23,    36,    34,    16,
	  20,    28,    24,    36,    37,    21,    14,    19,    28,
	  32,    25,    21,    18,    28,    36,    28,    11,    15,
	  36,    33,    27,    20,    18,    22,    33,    34,    21,
	  23,    29,    20,    25,    26,    18,    18,    24,    28,
	  18,    21,    21,    15,    24,    21,    28,    18,    16,
	  17,    18,    26,    27,    28,    23,     7,    15,    27,
	  29,    22,    14,    20,    22,    27,    23,    20,    17,
	  25,    27,    21,    15,    21,    21,    26,    25,    25,
	  23,    18,    31,    24,    24,    25,    21,    19,    22,
	  20,    21,    26,    23,    20,    23,    21,    20,    20,
	  20,    32,    27,    26,    19,    23,    25,    27,    26,
	  24,    30,    26,    22,    22,    30,    29,    30,    18,
	  23,    29,    31,    14,    15,    23,    28,    29,    25,
	  17,    14,    31,    29,    22,    15,    21,    25,    29,
	  25,    18,    23,    30,    32,    19,    16,    14,    24,
	  28,    26,    13,    14,    23,    27,    21,    19,    15,
	  15,    25,    20,    19,    16,    21,    21,    27,    25,
	  21,    17,    16,    22,    24,    31,    17,    13,    22,
	  25,    22,    22,    21,    20,    21,    22,    21,    19,
	  23,    18,    19,    29,    25,    18,    11,    20,    24,
	  25,    23,    18,    19,    16,    20,    26,    27,    24,
	  15,    14,    16,    27,    24,    18,    17,    23,    30,
	  22,    16,    18,    29,    27,    26,    19,    18,    21,
	  31,    32,    24,    20,    23,    29,    22,    20,    22,
	  28,    23,    26,    24,    20,    25,    26,    26,    24,
	  27,    24,    25,    25,    27,    25,    31,    30,    28,
	  24,    25,    28,    30,    31,    27,    29,    28,    28,
	  33,    40,    37,    36,    35,    32,    28,    35,    31,
	  38,    40,    35,    33,    31,    34,    41,    42,    31,
	  31,    29,    38,    36,    31,    30,    33,    40,    32,
	  25,    21,    26,    34,    35,    27,    24,    25,    34,
	  32,    27,    23,    29,    27,    25,    23,    24,    27,
	  28,    36,    27,    23,    18,    26,    25,    22,    25,
	  25,    23,    24,    24,    21,    20,    22,    26,    25,
	  21,    15,    17,    22,    25,    25,    19,    21,    15,
	  13,    13,    16,    19,    15,    12,     6,     8,    18,
	  21,    12,    10,    14,    18,    18,    10,     9,    18,
	  26,    23,     8,    12,    19,    21,    22,    19,    21,
	  20,    20,    17,    17,    21,    29,    26,    19,    20,
	  18,    21,    24,    25,    23,    23,    27,    28,    20,
	  24,    32,    25,    24,    27,    27,    23,    27,    29,
	  28,    31,    29,    25,    24,    27,    28,    24,    24,
	  26,    30,    27,    24,    23,    24,    29,    28,    27,
	  22,    20,    26,    27,    30,    30,    30,    22,    24,
	  20,    28,    31,    31,    19,    25,    26,    27,    24,
	  24,    27,    27,    22,    13,    12,    21,    25,    21,
	  20,    20,    15,    15,    20,    14,    18,    20,    17,
	   8,     9,    16,    18,    16,    15,    13,    13,    14,
	  10,     8,    16,    21,    17,    11,    14,    13,    13,
	  11,    19,    15,    12,     3,     8,    20,    20,    14,
	  11,    12,    11,    16,    14,    11,     9,    17,    17,
	  13,     8,     5,    10,    20,    20,     8,     7,    12,
	  19,    13,    15,    13,    19,    23,    13,    11,    13,
	  18,    23,    21,    18,    17,    20,    23,    20,    24,
	  25,    22,    16,    21,    22,    22,    23,    25,    25,
	  22,    24,    23,    24,    29,    29,    25,    24,    23,
	  26,    32,    25,    24,    26,    29,    28,    23,    18,
	  15,    28,    30,    26,    22,    23,    22,    26,    26,
	  27,    28,    24,    22,    25,    26,    23,    25,    26,
	  28,    25,    24,    19,    21,    27,    28,    26,    22,
	  18,    25,    30,    27,    22,    25,    24,    18,    18,
	  23,    23,    25,    26,    23,    24,    24,    22,    15,
	  19,    26,    29,    21,    16,    14,    20,    25,    26,
	  22,    16,    21,    21,    20,    20,    26,    30,    27,
	  29,    24,    26,    26,    30,    31,    32,    29,    26,
	  23,    28,    31,    34,    31,    24,    23,    27,    29,
	  28,    31,    32,    33,    27,    21,    24,    33,    35,
	  31,    28,    25,    30,    31,    30,    33,    30,    32,
	  33,    27,    24,    25,    31,    33,    30,    29,    25,
	  24,    26,    25,    30,    34,    30,    25,    22,    29,
	  33,    30,    28,    33,    35,    28,    28,    32,    37,
	  39,    34,    29,    32,    33,    28,    27,    29,    30,
	  26,    20,    17,    23,    26,    27,    25,    23,    22,
	  22,    22,    22,    25,    26,    26,    22,    23,    22,
	  24,    29,    30,    25,    23,    24,    25,    27,    27,
	  25,    25,    25,    27,    25,    20,    20,    28,    29,
	  27,    24,    22,    18,    15,    24,    27,    26,    22,
	  18,    21,    20,    22,    21,    23,    26,    18,    17,
	  24,    26,    23,    26,    29,    24,    21,    21,    22,
	  29,    36,    28,    18,    22,    28,    29,    28,    22,
	  23,    26,    29,    23,    18,    22,    25,    31,    27,
	  20,    16,    19,    24,    25,    25,    27,    24,    21,
	  20,    18,    17,    21,    21,    11,    15,    18,    16,
	  16,    22,    23,    17,    14,    14,    14,    15,    18,
	  21,    19,    19,    15,    14,    16,    19,    19,    19,
	  19,    17,    13,    11,    20,    28,    24,    15,    13,
	  14,    16,    24,    23,    19,    19,    20,    15,    14,
	  17,    25,    24,    20,    15,    16,    21,    20,    22,
	  22,    22,    21,    20,    17,    21,    19,    21,    24,
	  24,    19,    18,    20,    19,    23,    26,    22,    19,
	  25,    26,    19,    20,    29,    31,    30,    24,    19,
	  22,    26,    29,    30,    24,    19,    18,    24,    29,
	  30,    29,    22,    23,    24,    22,    20,    23,    25,
	  30,    31,    22,    16,    20,    28,    33,    24,    20,
	  24,    24,    25,    31,    29,    23,    23,    24,    24,
	  20,    22,    25,    28,    25,    23,    22,    23,    22,
	  23,    25,    26,    26,    22,    21,    27,    33,    26,
	  23,    26,    30,    25,    21,    21,    30,    31,    29,
	  19,    14,    19,    29,    31,    27,    19,    16,    25,
	  26,    19,    19,    21,    27,    26,    20,    14,    20,
	  27,    29,    24,    21,    23,    25,    29,    30,    29,
	  31,    32,    26,    28,    28,    28,    31,    35,    33,
	  28,    31,    30,    30,    32,    34,    31,    33,    33,
	  26,    22,    31,    40,    34,    32,    29,    27,    31,
	  34,    31,    26,    31,    36,    33,    29,    27,    27,
	  35,    40,    30,    23,    29,    32,    34,    37,    32,
	  27,    29,    35,    33,    26,    31,    35,    34,    35,
	  30,    23,    31,    38,    33,    30,    29,    24,    25,
	  32,    28,    24,    29,    28,    23,    24,    20,    16,
	  21,    29,    26,    19,    18,    19,    21,    29,    27,
	  21,    15,    19,    20,    19,    21,    21,    21,    18,
	  18,    16,    18,    21,    21,    19,    21,    21,    17,
	  15,    21,    23,    24,    21,    18,    15,    17,    19,
	  18,    20,    19,    17,    19,    15,    16,    19,    18,
	  19,    18,    15,    12,    16,    20,    20,    21,    20,
	  15,    14,    14,    20,    17,    15,    17,    20,    16,
	  11,    12,    17,    22,    19,    13,     9,    13,    16,
	  17,    19,    19,    18,    13,    13,    16,    17,    21,
	  22,    18,    18,    21,    17,    12,    17,    22,    20,
	  19,    14,     8,    11,    21,    19,    16,    16,    18,
	  13,    15,    18,    19,    18,    20,    20,    14,    13,
	  20,    23,    21,    22,    21,    18,    16,    20,    21,
	  22,    23,    22,    20,    20,    22,    23,    22,    25,
	  26,    21,    18,    22,    24,    27,    26,    24,    25,
	  27,    21,    17,    24,    26,    25,    26,    22,    16,
	  20,    26,    25,    23,    21,    17,    19,    21,    23,
	  24,    25,    24,    24,    21,    21,    22,    28,    29,
	  29,    27,    26,    26,    23,    27,    31,    27,    21,
	  23,    23,    21,    22,    25,    26,    24,    24,    18,
	  18,    23,    26,    26,    24,    23,    17,    17,    23,
	  29,    28,    24,    19,    20,    22,    21,    20,    21,
		  25, 22, 20, 18, 16, 20, 29, 27, 19 };

	std::complex<float> H[4096];

	float h1[N - M];
	float OLAP[M][2];
	int size_OLAP = M;

	float xr_zeropadded[N];
};
